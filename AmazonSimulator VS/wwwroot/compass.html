<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Compass</title>
</head>

<body style="margin:0px; padding:0px; overflow:hidden; border: 1px solid;">

    <script src="lib/ResizeSensor.js"></script>
    <script src="lib/ElementQueries.js"></script>

    <!-- Three libs -->
    <script src="lib/three.js"></script>

    <!-- Utility functions -->
    <script src="js/Utils.js"></script>

    <!-- Arbitrary, UI-related event handlers -->
    <script src="js/Interfacing.js"></script>

    <div id="viewport" style="width: 100vw; height: 100vh;"></div>

    <script>

        var viewport;

        var camera, scene, renderer;

        var listenersX = [];
        var listenersY = [];
        var listenersZ = [];

        var mouse;

        window.onload = init;

        var compass;

        var UpdateOrientation = function ( camera ) 
        {
            compass.quaternion.setFromRotationMatrix(
                new THREE.Matrix4().extractRotation( camera.matrixWorldInverse )
            );

        }

        var setClearColor = function ( color, alpha )
        {
            renderer.setClearColor( color, alpha );
        }

        var addEventListenerX = function ( fnc ) 
        {

            listenersX.push( fnc );

        }

        var addEventListenerY = function ( fnc ) 
        {

            listenersY.push( fnc );

        }

        var addEventListenerZ = function ( fnc ) 
        {

            listenersZ.push( fnc );

        }

        function init()
        {
            viewport = document.getElementById( 'viewport' );

            viewport.addEventListener( 'click', onClick );

            initGFX();

            mouse = new INTERFACING.Mouse( viewport );

            requestAnimationFrame( render );

        }

        function render()
        {
            // Render the scene
            renderer.render( scene, camera );

            // Schedule the next call to render()
            requestAnimationFrame( render );

        }

        function createCompass()
        {
            compass = new THREE.Group();

            let l = 0.25;
            let w = 0.02;
            let al = 0.075;

            let x = new THREE.ArrowHelper( new THREE.Vector3( 1, 0, 0 ), 0, l, 0xff0000, al, w );
            let y = new THREE.ArrowHelper( new THREE.Vector3( 0, 1, 0 ), 0, l, 0x00ff00, al, w );
            let z = new THREE.ArrowHelper( new THREE.Vector3( 0, 0, 1 ), 0, l, 0x0000ff, al, w );

            x.name = "ArrowX";
            y.name = "ArrowY";
            z.name = "ArrowZ";

            x.position.x = 0; x.position.y = 0; x.position.z = 0;
            y.position.x = 0; y.position.y = 0; y.position.z = 0;
            z.position.x = 0; z.position.y = 0; z.position.z = 0;

            compass.add( x );
            compass.add( y );
            compass.add( z );

            compass.name = "compass";
            scene.add( compass );

        }

        function initGFX()
        {
            // Initialize default camera
            camera = new THREE.PerspectiveCamera( 30, viewport.clientWidth / viewport.clientHeight, 0.2, 10 );
            camera.position.set( 0, 0.0, 1 );

            // Renderer setup
            renderer = new THREE.WebGLRenderer( { alpha: true } );

            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( viewport.clientWidth, viewport.clientHeight );

            // Add renderer to document
            viewport.appendChild( renderer.domElement );

            // Default window scaling & camera frustum adjusting
            INTERFACING.StartResizeHandler( viewport, camera, renderer );

            // Basic scene with an assisting grid
            scene = new THREE.Scene();
            createCompass();
        }

        function onClick()
        {
            let caster = new THREE.Raycaster();
            caster.setFromCamera( mouse.getPosition(), camera );

            let intersects = UTILS.FindIntersects( caster, compass.children );

            for ( const intersect of intersects )
            {
                console.log( "Intersects: " + intersect.name );

                switch ( intersect.name )
                {

                    case "ArrowX":
                        for ( const listener of listenersX ) listener();
                        break;

                    case "ArrowY":
                        for ( const listener of listenersY ) listener();
                        break;

                    case "ArrowZ":
                        for ( const listener of listenersZ ) listener();
                        break;

                }

            }

        }
    </script>
</body>

</html>
